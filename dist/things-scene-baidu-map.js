!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@hatiolab/things-scene")):"function"==typeof define&&define.amd?define(["@hatiolab/things-scene"],t):(e=e||self)["things-scene-baidu-map"]=t(e.scene)}(this,function(e){"use strict";const t={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"number",label:"latitude",name:"lat"},{type:"number",label:"longitude",name:"lng"},{type:"number",label:"zoom",name:"zoom"},{type:"string",label:"api-key",name:"apiKey"}],"value-property":"latlng"};class n extends e.HTMLOverlayContainer{static load(t){var n=t.get("apiKey")||"bMxSipKRYIqOi2q4M7XR7IqKM2Xt3fNy";e.ScriptLoader.load(`http://api.map.baidu.com/getscript?v=3.0&ak=${n}`).then(()=>t.onload(),e.error)}ready(){super.ready(),this.rootModel&&(this._listenTo=this.rootModel,this._listener=function(e){e.scale&&this.rescale()}.bind(this),this.rootModel.on("change",this._listener))}removed(){this._listenTo&&(this._listenTo.off("change",this._listener),delete this._listenTo,delete this._listener)}rescale(){var e=this._anchor;if(e){var t=function(e){for(var t={x:1,y:1},n=e;n;){let{x:e,y:a}=n.get("scale")||{x:1,y:1};t.x*=e||1,t.y*=a||1,n=n.parent}return t}(this),n=`scale(${1/t.x}, ${1/t.y})`;["-webkit-","-moz-","-ms-","-o-",""].forEach(t=>{e.style[t+"transform"]=n,e.style[t+"transform-origin"]="0px 0px"});var{width:a,height:i}=this.model;if(e.style.width=Math.round(a*t.x)+"px",e.style.height=Math.round(i*t.y)+"px",this.loaded){let{lat:e,lng:t,zoom:n}=this.model,a=new BMap.Point(t,e);this.map.centerAndZoom(a,n),setTimeout(()=>{this.buildMarkers()},200)}}}createElement(){super.createElement(),this._anchor=document.createElement("div"),this.element.appendChild(this._anchor),this._markerComponents=[],this._markers=[],this._onmarkerchange=this.onmarkerchange.bind(this),n.load(this)}onload(){this.loaded=!0,this._map=this.createMap(),this.buildMarkers(),this.rescale()}createMap(){let e=new BMap.Map(this._anchor,{minZoom:4,maxZoom:20,enableAutoResize:!0,enableHighResolution:!0});return e.enableScrollWheelZoom(),e.enableAutoResize(),e.addControl(new BMap.MapTypeControl({mapTypes:[BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]})),e}get tagName(){return"div"}get map(){return this._map}dispose(){super.dispose(),this._markerComponents&&this._markerComponents.slice().forEach(e=>{this.removeMarker(e)}),delete this._markerComponents,delete this._markers,delete this._anchor}buildMarkers(){var e=[];this.map.clearOverlays(),this._markerComponents.forEach(t=>{let{lat:n,lng:a}=t.model,i=new BMap.Point(a,n),r=new BMap.Marker(i);e.push(r),this.map.addOverlay(r),t.marker=r}),this._markers=e}touchMarker(e){var t=this._markerComponents.indexOf(e);if(-1==t||!this.loaded)return;var n=this._markers[t],{lat:a,lng:i}=e.model;let r=new BMap.Point(i,a);n.setPosition(new BMap.Point(r))}onmarkerchange(e,t,n){var a=n.origin;(e.hasOwnProperty("lat")||e.hasOwnProperty("lng"))&&this.touchMarker(a)}addMarker(e){this._markerComponents||(this._markerComponents=[]);var t=this._markerComponents,n=this._markers;if(-1==t.indexOf(e)){if(t.push(e),e.on("change",this._onmarkerchange),!this.loaded)return;let{lat:a,lng:i}=e.model,r=new BMap.Point(i,a),o=new BMap.Marker(r);n.push(o),this.map&&this.map.addOverlay(o),e.marker=o}}removeMarker(e){if(this._markerComponents){var t=this._markerComponents.indexOf(e);if(-1!=t){e.off("change",this._onmarkerchange),e.marker=null,this._markerComponents.splice(t,1);var n=this._markers.splice(t,1);n.length>0&&this.map&&this.map.removeOverlay(n[0]),e.marker=null}}}get markers(){return this._markerComponents||(this._markerComponents=[],this._markers=[]),this._markers}setElementProperties(e){this.rescale()}onchange(e,t){super.onchange(e,t),(e.lng||e.lat)&&this.convertLatLng(),this.rescale()}convertLatLng(e,t){var n=new BMap.Convertor,a=[];a.push(new BMap.Point(e,t)),n.translate(a,3,5,e=>{if(0===e.status){let t=e.points[0];this.set("latlng",t)}})}get latlng(){return this.get("latlng")}set latlng(e){this.set(e)}get nature(){return t}}e.Component.register("baidu-map",n);const a={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"target-map",name:"targetMap"},{type:"number",label:"latitude",name:"lat"},{type:"number",label:"longitude",name:"lng"}],"value-property":"latlng"};class i extends(e.RectPath(e.Shape)){static get nature(){return a}dispose(){var e=this.findMap();e&&e.removeMarker(this),delete this._infoWindow,delete this._marker,super.dispose()}ready(){super.ready();var e=this.findMap();e&&e.addMarker(this)}get infoWindow(){if(!this._infoWindow){this._infoWindow=new BMap.InfoWindow("",{maxWidth:322,width:322})}return this._infoWindow}findInfoWindow(e){var t=this.model.event,n=t&&t[e]&&t[e].infoWindow;if(n)return this.root.findById(n)}setInfoContent(t){var n=e.Component.template(t.model.frontSideTemplate),a=`<style>${t.model.style}\n      /*mouseover과 mouseout이 반복하여 발생하여 깜빡임 현상 해결을 위해 작성*/\n      .BMap_pop div:nth-child(8){\n        margin-left: 13px !important;\n      }\n      /*content 가운데 정렬*/\n      .BMap_bubble_content{\n        text-align: center;\n      }\n\n\n    </style>`+n(this);this.infoWindow.setContent(a)}openInfoWindow(e){this.setInfoContent(e);var t=this.findMap();if(!t||!t.map)return;let{lat:n,lng:a}=this.model,i=new BMap.Point(a,n);t.map.openInfoWindow(this._infoWindow,i)}onmarkerclick(e){var t=this.findInfoWindow("tap");t&&this.openInfoWindow(t),this.trigger("click",e)}onmarkermouseover(e){var t=this.findInfoWindow("hover");t&&this.openInfoWindow(t)}onmarkermouseout(e){this.findInfoWindow("hover")&&this.infoWindow.close()}set marker(e){this.findMap();e&&(e.addEventListener("click",this.onmarkerclick.bind(this)),e.addEventListener("mouseover",this.onmarkermouseover.bind(this)),e.addEventListener("mouseout",this.onmarkermouseout.bind(this)),this._marker=e)}get hidden(){return super.hidden||this.app.isViewMode}set hidden(e){super.hidden=e}_draw(e){var{top:t,left:n,width:a,height:i}=this.model;e.translate(n,t),e.beginPath(),e.moveTo(a/2,.9*i),e.bezierCurveTo(a/2.3,.6*i,0,i/2,0,i/4),e.ellipse(a/2,i/4,a/2,i/4,0,1*Math.PI,0*Math.PI),e.bezierCurveTo(a,i/2,a/1.7,.6*i,a/2,.9*i),e.closePath(),e.translate(-n,-t)}get controls(){}findMap(e){return(e=e||this.get("targetMap"))&&this.root.findById(e)}get click_handler(){return this._click_handler||(this._click_handler=this.onmarkerclick.bind(this)),this._click_handler}onchange(e,t){t.targetMap&&((n=this.findMap(t.targetMap))&&n.removeMarker(this));if(e.targetMap){var n;(n=this.findMap(e.targetMap))&&n.addMarker(this)}super.onchange&&super.onchange(e,t)}get latlng(){return{lat:this.get("lat"),lng:this.get("lng")}}set latlng(e){this.set(e)}}e.Component.register("bmap-marker",i);const r={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"target-map",name:"targetMap"},{type:"number",label:"latitude",name:"lat"},{type:"number",label:"longitude",name:"lng"},{type:"image-selector",label:"image-src",name:"imageSrc",property:{displayField:"id",displayFullUrl:!0,baseUrlAlias:"$base_url",defaultStorage:"scene-image",storageFilters:{type:Array,value:[{name:"category",value:"image"}]},useUpload:!0}},{type:"string",label:"center-name",name:"centerName"},{type:"string",label:"address",name:"address"},{type:"string",label:"tel-num",name:"telNum"},{type:"select",label:"popup-event-type",name:"popupEventType",property:{options:[{display:"click",value:"click"},{display:"hover",value:"hover"}]}},{type:"number",label:"popup-height",name:"popupHeight"},{type:"number",label:"popup-width",name:"popupWidth"},{type:"cjmarker-content",label:"cjmarker-content",name:"content"}],"value-property":"latlng"};class o extends(e.RectPath(e.Shape)){static get nature(){return r}dispose(){var e=this.findMap();e&&e.removeMarker(this),delete this._infoWindow,delete this._marker,super.dispose()}ready(){super.ready();var e=this.findMap();e&&e.addMarker(this)}get infoWindow(){if(!this._infoWindow){var e,t,n,a,i,r={maxWidth:322,width:this.get("popupWidth")||440,height:this.get("popupHeight")||320};e=t=n=a="",i=[];var o=this.app.url(this.get("imageSrc"))||"";if(this.state&&this.state.data&&(e=this.get("centerName")||"",t=this.get("address")||"",n=this.get("telNum")||"",(i=this.get("content")||[]).length>0)){a+='<table class="data_table">';for(var s=0;s<i.length;s++)a+=`<tr><td>${i[s].name}</td>\n            <td>${this.data[i[s].qty]||""}</td>\n            <td>${i[s].unit}</td></tr>`;a+="</table>"}this._infoWindow=new BMap.InfoWindow(`<style>\n      /*mouseover과 mouseout이 반복하여 발생하여 깜빡임 현상 해결을 위해 작성*/\n      .BMap_pop div:nth-child(8){\n        margin-left: 13px !important;\n      }\n      /*content 가운데 정렬*/\n      .BMap_bubble_content{\n        text-align: center;\n      }\n\n      .BMap_bottom + div, .BMap_center + div, .BMap_pop + div, .BMap_top + div {\n        overflow:initial !important;\n      }\n\n      .BMap_bottom{\n        border-top: 1px solid #fff !important;\n        margin-top: -1px;\n      }\n\n      .info{\n        display: block;\n      }\n\n      .info.last{\n        padding-bottom: 8px;\n      }\n      \n      .data_table{\n        width:100%; \n        height:100%; \n        margin:auto; \n        text-align:center;\n        top: -50%;\n      }\n\n      .data_table td{\n        padding: 5px;\n        border-bottom: 1px solid #444444;\n      }\n\n      #topLogo{\n        width: 200px;\n        height: 90px;\n      }\n     </style> \n        <div style="background-color:white">\n          <img id ="topLogo" src="${o}"/>\n          <h2>${e}</h2>\n          <span class="info">${t}</span>\n          <span class="info last">${n}</span>\n          ${a}\n        </div>\n        `,r)}return this._infoWindow}openInfoWindow(){var e=this.findMap();if(!e||!e.map)return;let{lat:t,lng:n}=this.model,a=new BMap.Point(n,t);e.map.openInfoWindow(this.infoWindow,a)}onmarkerclick(e){"click"!=this.get("popupEventType")&&this.get("popupEventType")||this.openInfoWindow()}onmarkermouseover(e){"hover"==this.get("popupEventType")&&this.openInfoWindow()}onmarkermouseout(e){"hover"==this.get("popupEventType")&&this.infoWindow.close()}set marker(e){this.findMap();e&&(e.addEventListener("click",this.onmarkerclick.bind(this)),e.addEventListener("mouseover",this.onmarkermouseover.bind(this)),e.addEventListener("mouseout",this.onmarkermouseout.bind(this)),this._marker=e)}get hidden(){return super.hidden||this.app.isViewMode}set hidden(e){super.hidden=e}_draw(e){var{top:t,left:n,width:a,height:i}=this.model;e.translate(n,t),e.beginPath(),e.moveTo(a/2,.9*i),e.bezierCurveTo(a/2.3,.6*i,0,i/2,0,i/4),e.ellipse(a/2,i/4,a/2,i/4,0,1*Math.PI,0*Math.PI),e.bezierCurveTo(a,i/2,a/1.7,.6*i,a/2,.9*i),e.closePath(),e.translate(-n,-t)}get controls(){}findMap(e){return(e=e||this.get("targetMap"))&&this.root.findById(e)}get click_handler(){return this._click_handler||(this._click_handler=this.onmarkerclick.bind(this)),this._click_handler}onchange(e,t){t.targetMap&&((n=this.findMap(t.targetMap))&&n.removeMarker(this));if(e.targetMap){var n;(n=this.findMap(e.targetMap))&&n.addMarker(this)}super.onchange&&super.onchange(e,t)}get latlng(){return{lat:this.get("lat"),lng:this.get("lng")}}set latlng(e){this.set(e)}}return e.Component.register("cj-marker",o),[n,i,o]});
